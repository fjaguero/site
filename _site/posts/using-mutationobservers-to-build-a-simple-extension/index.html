<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using MutationObservers to build a simple extension</title>
  <meta name="description" content="Have you ever have the need to listen to DOM changes? I did. That’s why I built a simple extension by using Mutation Observers. Let’s get some context.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/posts/using-mutationobservers-to-build-a-simple-extension/">
  <link rel="alternate" type="application/rss+xml" title="Fernando Agüero" href="http://localhost:4000/feed.xml">
  <link href="https://fonts.googleapis.com/css?family=Merriweather:700|Open+Sans" rel="stylesheet">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Fernando Agüero</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About me</a>
          
          
          
          <a class="page-link" href="/another-page/">Another page</a>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <a class="page-link" href="/posts">Posts</a>
          <a class="page-link" href="/notes">Notes</a>
          <a class="page-link" href="/bookmarks">Bookmarks</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using MutationObservers to build a simple extension</h1>
    <p class="post-meta"><time datetime="2018-04-16T01:15:49+00:00" itemprop="datePublished">Apr 16, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Have you ever have the need to <em>listen</em> to DOM changes? I did. That’s why I built a simple extension by using <em>Mutation Observers</em>. Let’s get some context.</p>

<h3 id="dom-mutations-apis">DOM mutations APIs</h3>
<p>Listening to DOM changes was possible with the past DOM3 specification, but it didn’t have good, specific API: you needed to use event listeners.</p>

<h5 id="previously-on-dom3">Previously on DOM3</h5>

<p>This was called <em>Mutation Events</em> and it exposed a list of events you were able to listen to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*  DOMAttrModified
*  DOMAttributeNameChanged
*  DOMCharacterDataModified 
*  DOMElementNameChanged
*  DOMNodeInserted
*  DOMNodeInsertedIntoDocument
*  DOMNodeRemoved
*  DOMNodeRemovedFromDocument
*  DOMSubtreeModified
</code></pre></div></div>

<p>Usage example:</p>
<pre><code class="language-language-javascript">element.addEventListener("DOMNodeInserted", function (ev) {
  // ...
}, false);
</code></pre>
<hr />
<h4 id="meet-the-dom4-mutation-observers">Meet the DOM4 Mutation Observers</h4>
<p>Now we have a better API in the <a href="http://www.w3.org/TR/dom/#mutation-observers">DOM4</a> specification, <strong>MutationObservers.</strong> This specification became a W3C recommendation on 19 November 2015.</p>

<p><a href="https://developer.mozilla.org/en/docs/Web/API/MutationObserver">MutationObservers</a> has a more complex API that the previous method, but it’s specifically designed for the requirements. The good thing here is that you specify which DOM changes you will be <em>observing</em> when instanciating the observer.</p>

<p>In my case I will be observing the DOM mutations when the subtree is changed.</p>

<p>An implementation example:</p>

<pre><code class="language-language-javascript">// select the target node
var target = document.querySelector('#some-id');
 
// create an observer instance
var observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    console.log(mutation.type);
  });    
});
 
// configuration of the observer:
var config = { attributes: true, childList: true, characterData: true };
 
// pass in the target node, as well as the observer options
observer.observe(target, config);
 
// later, you can stop observing
observer.disconnect();
</code></pre>

<h6 id="browser-support">Browser support</h6>

<p>It’s expected that IE 11 is the only version that supports MutationObservers, since they already stated that it will be the last support version. The new versions of Edge already supports this feature, as well other modern browsers.</p>

<p><img src="/content/images/2016/02/mutation.png" alt="Browser Support" /></p>

<h3 id="building-a-poc-extension">Building a PoC extension</h3>

<p>I built a small <a href="https://github.com/fjaguero/twitter-replies-counter">Chrome extension</a> (<em>port to WebExtension soon, they ship on Firefox stable on March 2016!</em>) that simply counts the number of replies a tweet has. This is done by observing a div (the twitter popup) and counting the number of subtree modifications (each modification is a reply).</p>

<p><strong>Extension example usage</strong>
<img src="https://camo.githubusercontent.com/0ac2c364825f373503b8220879c51424e5a67b95/687474703a2f2f636c2e6c792f334f324a336830733342325a2f53637265656e2532305265636f7264696e67253230323031362d30322d3237253230617425323030342e3134253230702e2532306d2e2e676966" alt="Extension" /></p>

<p><strong>Content script</strong></p>

<p>This script is injected when the page is loaded:</p>

<pre><code class="language-language-javascript">$(document).ready(function() {
  // Select the target node (tweet modal)
  var target = $('.PermalinkOverlay-modal').get(0);

  // Create an observer instance
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {

      // Get the Twitter modal window replies count
      var loneTweetsCount = $('.PermalinkOverlay-body .ThreadedConversation--loneTweet .tweet').length
      var threadedTweetsCount = $('.PermalinkOverlay-body .ThreadedConversation .tweet').length
      var total = loneTweetsCount + threadedTweetsCount

      // Send message to background.js so we can set the badge text
      chrome.extension.sendMessage({'count': total})

    });
  });

  // Configuration of the observer
  var config = { attributes:true, subtree: true };

  // Pass in the target node, as well as the observer options
  observer.observe(target, config);

});
</code></pre>

<p>Note that I’m using <code class="highlighter-rouge">chrome.extension.sendMessage</code> so I can send a message to the background-script. The background-script is able to use many of the browser APIs that are not available on the injected script (content-script).</p>

<p><strong>Background script</strong></p>

<p>On the background-script I listen to that message and change the badge text. That’s all.</p>

<pre><code class="language-language-javascript">// Listen to content.js events
chrome.extension.onMessage.addListener(
  function(request, sender, sendResponse) {
    if (request.count || request.count === 0) {
      chrome.browserAction.setBadgeText({'text': request.count.toString()})
    }
  }
);
</code></pre>

<p>It’s great to see how the browsers APIs gets more and more powerful and easy to use… keeping in mind that the Web can run anywhere!</p>

<p>Never settle.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <ul>
      <li>
        <a href="https://medium.com/@fjaguero">Medium</a>
      </li>
      <li>
        <a href="https://twitter.com/@fjaguero">Twitter</a>
      </li>
      <li>
        <a href="http://github.com/fjaguero">Github</a>
      </li>
      <li>
        <a href="https://www.linkedin.com/in/fjaguero/" title="LinkedIn">LinkedIn</a>
      </li>
    </ul>

  </div>

</footer>


  </body>

</html>
